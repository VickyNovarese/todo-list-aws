pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  parameters {
    choice(name: 'DEPLOY_STAGE', choices: ['default', 'staging', 'production'], description: 'SAM Parameter: Stage')
    string(name: 'AWS_REGION', defaultValue: 'us-east-1', description: 'AWS Region')
    string(name: 'STACK_NAME', defaultValue: 'todo-list-aws', description: 'CloudFormation/SAM stack name')
  }

  environment {
    // Python venv
    VENV = ".venv"

    // Local test services
    FLASK_APP = "app/api.py"
    FLASK_HOST = "127.0.0.1"
    FLASK_PORT = "5000"

    WIREMOCK_JAR  = "test/wiremock/wiremock-standalone-3.13.2.jar"
    WIREMOCK_PORT = "9090"

    AWS_DEFAULT_REGION = "${params.AWS_REGION}"
  }

  stages {

    stage('Checkout') {
      steps {
        // âœ… Best for Multibranch Pipeline (or Pipeline with SCM configured)
        checkout scm

        sh '''
          set -e
          echo "WORKSPACE: $WORKSPACE"
          echo "BRANCH_NAME: ${BRANCH_NAME:-}"
          echo "CHANGE_ID: ${CHANGE_ID:-}"
          echo "CHANGE_BRANCH (PR source): ${CHANGE_BRANCH:-}"
          echo "CHANGE_TARGET (PR target): ${CHANGE_TARGET:-}"
          git rev-parse --abbrev-ref HEAD || true
          ls -la
        '''
      }
    }

    // -------------------------
    // Gate rules:
    // - Deploy only on master
    // - Must come from develop (only enforce strongly when it's a PR build)
    // -------------------------
    stage('Gate: allow deploy only for master merges from develop') {
      when { branch 'master' }
      steps {
        script {
          def src = env.CHANGE_BRANCH ?: ''
          def tgt = env.CHANGE_TARGET ?: ''

          // If this is a PR context in multibranch, enforce strictly
          if (env.CHANGE_ID) {
            echo "PR build detected: #${env.CHANGE_ID} source=${src} target=${tgt}"
            if (tgt != 'master') {
              error("This pipeline deploy gate expects PR target=master. Got target=${tgt}")
            }
            if (src != 'develop') {
              error("This pipeline only deploys when PR source is develop. Got source=${src}")
            }
          } else {
            // Not a PR build (likely direct push/merge). Best-effort check.
            echo "Not a PR context. Best-effort validation for 'from develop'."

            def parents = sh(script: "git rev-list --parents -n 1 HEAD | wc -w", returnStdout: true).trim()
            def isMergeCommit = (parents as Integer) >= 3
            if (!isMergeCommit) {
              echo "HEAD is not a merge commit (possible squash/rebase). Cannot reliably validate source branch."
              // If you want to BLOCK squash merges into master, uncomment:
              // error("Merge into master must be a merge commit from develop (no squash/rebase).")
            } else {
              def mergeMsg = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim().toLowerCase()
              echo "Merge message: ${mergeMsg}"
              if (!mergeMsg.contains('develop')) {
                echo "Could not confirm via message that it came from develop (heuristic)."
              }
            }
          }
        }
      }
    }

    stage('Setup Python & Tools') {
      steps {
        sh '''
          set -e

